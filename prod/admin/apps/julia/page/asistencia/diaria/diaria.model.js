"use strict";import{environment}from"../../../../../../environment.js";var KTDiaria=function(){var e,a,o,t,n=[],r=()=>{o=new Handsontable(document.querySelector("#HSTable"),{width:"100%",height:"auto",dropdownMenu:!0,fixedColumnsStart:1,hiddenColumns:{columns:[3]},multiColumnSorting:!0,filters:!0,rowHeaders:!0,manualColumnResize:!0,autoWrapRow:!0,autoWrapCol:!0,width:"100%",colWidths:[250,120,100,100,100,100,100,140,160,160,180,180,250,250],cells:function(e,a){const o={};return 0!==a&&1!==a&&2!==a&&4!==a&&7!==a&&10!==a&&11!==a&&12!==a&&13!==a||o.renderer||(o.renderer=function(e,a,o,t,n,r,i){if(Handsontable.renderers.TextRenderer.apply(this,arguments),0===o)a.style.backgroundColor="#DDF8FC";else{const t=e.getCell(o-1,0);if(t){const n=window.getComputedStyle(t).backgroundColor;e.getDataAtCell(o,0)==e.getDataAtCell(o-1,0)?a.style.backgroundColor=n:a.style.backgroundColor="rgb(221, 248, 252)"===n?"rgb(255, 255, 255)":"rgb(221, 248, 252)"}else a.style.backgroundColor="rgb(255, 255, 255)"}a.style.color="black"}),8!==a&&9!==a||o.renderer||(o.renderer=function(e,a,o,t,n,r,i){Handsontable.renderers.TextRenderer.apply(this,arguments),a.style.backgroundColor="#fbffb6",a.style.color="black"}),5===a&&this.instance.getDataAtCell(e,7)&&(o.readOnly=!0),o},licenseKey:"non-commercial-and-evaluation"});t=(e,a,...o)=>{Handsontable.renderers.TextRenderer(e,a,...o),a.style.color="white",a.style.background="#72abff"},Handsontable.renderers.registerRenderer("customStylesRenderer",t);const e=document.getElementById("noRecordsMessage");document.getElementById("HSTable").style.display="none",e.style.display="block"},i=()=>new Promise(((e,a)=>{msgLoad("Procesando...");var t=new FormData;t.append("usuario",$("#session_usuario_id").val()),t.append("usuario_rol",$("#session_rol_id").val()),t.append("periodo",$('[name="filtro-periodos"]').val()),t.append("fecha",$('[name="filtro-fecha"]').val()),t.append("colaborador",$('[name="filtro-colaborador"]').val()),t.append("ocupacion",$('[name="filtro-ocupacion"]').val()),t.append("desempenio",$('[name="filtro-desempenio"]').val()),t.append("areaperiodo",$('[name="filtro-areaperiodo"]').val()),t.append("estado",$('[name="filtro-estado"]').val()),t.append("tipo_m",$("#op_manana").is(":checked")?$("#op_manana").val():""),t.append("tipo_t",$("#op_tarde").is(":checked")?$("#op_tarde").val():""),t.append("tipo_n",$("#op_noche").is(":checked")?$("#op_noche").val():""),fetch(`${environment.apiSRD}/API/julia/asistencia/diaria/listar-paginado`,{method:"POST",body:t}).then((e=>e.json())).then((a=>{const t=document.getElementById("noRecordsMessage"),n=document.getElementById("HSTable");if(1==a.estado){const r=a.data;if(0===r.length)n.style.display="none",t.style.display="block";else{n.style.display="block",t.style.display="none";const a=Object.keys(r[0]),i=r.map((e=>Object.values(e)));o.updateSettings({data:i,colHeaders:a,columns:a.map((()=>({type:"text"}))),width:"100%"}),Promise.all([d(),s()]).then((([a,t])=>{o.updateSettings({columns:[{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"dropdown",source:a},{type:"dropdown",source:t},{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"text",readOnly:!1},{type:"text",readOnly:!1},{type:"text",readOnly:!1},{type:"text",readOnly:!1}]}),e()}))}}else msgError(ErrorMensaje(a),(()=>{}),(()=>{}))})).catch((e=>{a(e)})),msgAutoClose()})),l=()=>{const e=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;o.updateSettings({height:e-300})};function d(){let e=new FormData;return e.append("estado",1),e.append("usuario",$("#session_usuario_id").val()),e.append("usuario_rol",$("#session_rol_id").val()),fetch(`${environment.apiSRD}/API/julia/turnos/listar-cmb-tabla`,{method:"POST",body:e}).then((e=>e.json())).then((e=>e.data))}function s(){let e=new FormData;return e.append("estado",1),e.append("usuario",$("#session_usuario_id").val()),e.append("usuario_rol",$("#session_rol_id").val()),fetch(`${environment.apiSRD}/API/julia/servicios/listar-cmb-tabla`,{method:"POST",body:e}).then((e=>e.json())).then((e=>e.data))}return{init:function(){e=document.getElementById("form_modal_filtro_diario"),new Promise(((e,o)=>{msgLoad("Procesando...");var t=new FormData;t.append("usuario",$("#session_usuario_id").val()),t.append("usuario_rol",$("#session_rol_id").val()),t.append("idapp","ENF_002"),t.append("estado",1);const n=$('[name="filtro-periodos"]');fetch(`${environment.apiSRD}/API/periodos/listar-cmb`,{method:"POST",body:t}).then((e=>e.json())).then((a=>{if(1===a.estado){const o=a.data.map((e=>({id:e.Id,text:e.Periodo,inicio:e.Inicio,fin:e.Fin})));n.empty(),n.select2({placeholder:"Seleccione un periodo",allowClear:!0,data:o}),n.val(o[0].id).trigger("change"),msgAutoClose(),e()}else console.error("Error en la respuesta:",a.mensaje),o(a.mensaje)})).catch((e=>{console.error("Error al obtener los periodos:",e),o(e)})),a=$("[name=filtro-fecha]").flatpickr({altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",locale:"es"}),n.on("change",(function(){const e=n.select2("data")[0];if(e){const o=e.inicio,t=e.fin;a.set("minDate",o),a.set("maxDate",t)}}))})).then((()=>{var a,t;r(),l(),o.addHook("afterChange",((e,a)=>{if("loadData"!==a&&e){n=[];let a=0;if(e.forEach((([e,t,r,i])=>{if(r!==i){var l=o.getColHeader(o.propToCol(t));n.push({colaborador:o.getDataAtRow(e)[0],id_horario_turno:o.getDataAtRow(e)[3],fecha:o.getDataAtRow(e)[4],hora_extra:o.getDataAtRow(e)[7],valor_nuevo:i,columna:l}),a+=1}})),a>0){let e=new FormData;e.append("cambios",JSON.stringify(n)),e.append("usuario",$("#session_usuario_id").val()),e.append("usuario_rol",$("#session_rol_id").val()),fetch(`${environment.apiSRD}/API/julia/asistencia/diaria/modificar-horario`,{method:"POST",body:e}).then((e=>e.json())).then((e=>{1==e.estado?e.data.cambios>0?i().then((()=>{msgSuccessMixin("Los cambios se han aplicado exitosamente","")})):i().then((()=>{msgWarningMixin("No se han realizado los cambios, verifique e intente de nuevo","")})):msgError(ErrorMensaje(e),(()=>{}),(()=>{}))}))}}})),document.querySelector("#boton-actualizar-horario").addEventListener("click",(function(e){e.preventDefault(),msgLoad("Procesando..."),i().then((()=>{msgSuccessMixin("Se han actualizado la tabla exitosamente","")}))})),document.querySelector("#boton-exportar-horario").addEventListener("click",(function(a){a.preventDefault(),msgLoad("Procesando...");var o=new FormData(e);o.append("usuario",$("#session_usuario_id").val()),o.append("usuario_rol",$("#session_rol_id").val()),o.append("periodo",$('[name="filtro-periodos"]').val()),o.append("fecha",$('[name="filtro-fecha"]').val()),o.append("colaborador",$('[name="filtro-colaborador"]').val()),o.append("ocupacion",$('[name="filtro-ocupacion"]').val()),o.append("desempenio",$('[name="filtro-desempenio"]').val()),o.append("areaperiodo",$('[name="filtro-areaperiodo"]').val()),o.append("estado",$('[name="filtro-estado"]').val()),o.append("tipo",$('[name="filtro-tipo"]').val()),fetch(`${environment.apiSRD}/API/julia/asistencia/diaria/listar`,{method:"POST",body:o}).then((e=>{if(e.ok)return e.blob();throw new Error("Error al generar el CSV")})).then((e=>{const a=window.URL.createObjectURL(e),o=document.createElement("a");o.href=a,o.download="CE_Lista_Asistencia_Diaria.csv",document.body.appendChild(o),o.click(),o.remove()})).catch((e=>{msgError("Error al procesar los datos: "+e,(()=>{}),(()=>{}))})).finally((()=>{msgSuccessMixin("Se ha descargado el documento exitosamente","")}))})),t=document.querySelector("#form_modal_filtro_diario"),a=FormValidation.formValidation(t,{fields:{"filtro-periodo":{validators:{notEmpty:{message:"El periodo es requerido"}}},"filtro-fecha":{validators:{notEmpty:{message:"La fecha es requerida"}}}},plugins:{trigger:new FormValidation.plugins.Trigger,bootstrap:new FormValidation.plugins.Bootstrap5({rowSelector:".fv-row",eleInvalidClass:"",eleValidClass:""})}}),document.querySelector("#kt_modal_filtro_diario_submit").addEventListener("click",(function(e){e.preventDefault(),a&&a.validate().then((function(e){"Valid"==e&&($("#kt_diario_filtro_modal").modal("hide"),i().then((()=>{msgSuccessMixin("Los cambios se han aplicado exitosamente","")})))}))})),document.querySelector("#kt_modal_filtro_diario_limpiar").addEventListener("click",(function(e){e.preventDefault(),$('[name="filtro-colaborador"]').val(null).trigger("change"),$('[name="filtro-ocupacion"]').val(null).trigger("change"),$('[name="filtro-desempenio"]').val(null).trigger("change"),$('[name="filtro-areaperiodo"]').val(null).trigger("change"),document.querySelector('input[name="filtro-estado"][value="1"]').checked=!1,document.querySelector('input[name="filtro-estado"][value="0"]').checked=!1,document.querySelector('input[name="filtro-tipo"][value="M"]').checked=!1,document.querySelector('input[name="filtro-tipo"][value="N"]').checked=!1,document.querySelector('input[name="filtro-tipo"][value="T"]').checked=!1,i().then((()=>{msgSuccessMixin("Los filtros se han limpiado exitosamente","")}))}))})).catch((e=>{console.error("Error durante la inicializaci√≥n:",e)}))},updateTableHeight:l}}();KTUtil.onDOMContentLoaded((function(){KTDiaria.init()})),window.addEventListener("resize",KTDiaria.updateTableHeight);