"use strict";import{environment}from"../../../../../../environment.js";var KTDiaria=function(){var e,a,t,o,n=[],r=()=>{msgLoad("Procesando...");var o=new FormData(e);o.append("usuario",$("#session_usuario_id").val()),o.append("usuario_rol",$("#session_rol_id").val());var n=$('[name="filtro-periodos"]').find("option");a=n.eq(1).val(),$('[name="filtro-periodos"]').val(a).trigger("change"),o.append("fecha","2024-05-01"),fetch(`${environment.apiSRD}/API/julia/asistencia/diaria/listar-paginado`,{method:"POST",body:o}).then((e=>e.json())).then((e=>{if(1==e.estado){const a=e.data,o=Object.keys(a[0]),n=a.map((e=>Object.values(e)));t.updateSettings({data:n,colHeaders:o,columns:o.map((()=>({type:"text"}))),width:"100%",cells:function(e,a){const t={};return 0!==a&&1!==a&&2!==a&&4!==a&&7!==a&&8!==a||(t.renderer=function(e,a,t,o,n,r,i){if(Handsontable.renderers.TextRenderer.apply(this,arguments),0===t)a.style.backgroundColor="#DDF8FC";else{const o=window.getComputedStyle(e.getCell(t-1,0)).backgroundColor;e.getDataAtCell(t,0)==e.getDataAtCell(t-1,0)?a.style.backgroundColor=o:a.style.backgroundColor="rgb(221, 248, 252)"===o?"rgb(255, 255, 255)":"rgb(221, 248, 252)"}a.style.color="black"}),9!==a&&10!==a||(t.renderer=function(e,a,t,o,n,r,i){Handsontable.renderers.TextRenderer.apply(this,arguments),a.style.backgroundColor="#fbffb6"}),t}}),Promise.all([s(),l()]).then((([e,a])=>{t.updateSettings({columns:[{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"dropdown",source:e},{type:"dropdown",source:a},{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"text",readOnly:!1},{type:"text",readOnly:!1},{type:"text",readOnly:!1},{type:"text",readOnly:!1}]})})),msgAutoClose()}else msgError(ErrorMensaje(e),(()=>{}),(()=>{}))}))},i=()=>new Promise(((a,o)=>{var n=new FormData(e);n.append("usuario",$("#session_usuario_id").val()),n.append("usuario_rol",$("#session_rol_id").val()),n.append("periodo",$('[name="filtro-periodos"]').val()),n.append("colaborador",$('[name="filtro-colaborador"]').val()),n.append("ocupacion",$('[name="filtro-ocupacion"]').val()),n.append("desempenio",$('[name="filtro-desempenio"]').val()),n.append("areaperiodo",$('[name="filtro-areaperiodo"]').val()),n.append("estado",$('[name="filtro-estado"]').val()),n.append("fecha","2024-05-01"),fetch(`${environment.apiSRD}/API/julia/asistencia/diaria/listar-paginado`,{method:"POST",body:n}).then((e=>e.json())).then((e=>{if(1==e.estado){const o=e.data,n=Object.keys(o[0]),r=o.map((e=>Object.values(e)));t.updateSettings({data:r,colHeaders:n,columns:n.map((()=>({type:"text"}))),width:"100%"}),Promise.all([s(),l()]).then((([e,o])=>{t.updateSettings({columns:[{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"dropdown",source:e},{type:"dropdown",source:o},{type:"text",readOnly:!0},{type:"text",readOnly:!0},{type:"text",readOnly:!1},{type:"text",readOnly:!1},{type:"text",readOnly:!1},{type:"text",readOnly:!1}]}),a()}))}else msgError(ErrorMensaje(e),(()=>{}),(()=>{}))})).catch((e=>{o(e)}))})),d=()=>{const e=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;t.updateSettings({height:e-300})};function s(){let e=new FormData;return e.append("estado",1),e.append("usuario",$("#session_usuario_id").val()),e.append("usuario_rol",$("#session_rol_id").val()),fetch(`${environment.apiSRD}/API/julia/turnos/listar-cmb-tabla`,{method:"POST",body:e}).then((e=>e.json())).then((e=>e.data))}function l(){let e=new FormData;return e.append("estado",1),e.append("usuario",$("#session_usuario_id").val()),e.append("usuario_rol",$("#session_rol_id").val()),fetch(`${environment.apiSRD}/API/julia/servicios/listar-cmb-tabla`,{method:"POST",body:e}).then((e=>e.json())).then((e=>e.data))}return{init:function(){t=new Handsontable(document.querySelector("#HSTable"),{width:"100%",height:"auto",dropdownMenu:!0,fixedColumnsStart:1,hiddenColumns:{columns:[3]},multiColumnSorting:!0,filters:!0,rowHeaders:!0,manualColumnResize:!0,autoWrapRow:!0,autoWrapCol:!0,colWidths:[250,120,100,100,100,100,100,160,160,180,180,250,250],licenseKey:"non-commercial-and-evaluation"}),o=(e,a,...t)=>{Handsontable.renderers.TextRenderer(e,a,...t),a.style.fontWeight="bold",a.style.color="green",a.style.background="#d7f1e1"},Handsontable.renderers.registerRenderer("customStylesRenderer",o),r(),d(),t.addHook("afterChange",((e,a)=>{if("loadData"!==a&&e){n=[];let a=0;if(e.forEach((([e,o,r,i])=>{if(r!==i){var d=t.getColHeader(t.propToCol(o));n.push({colaborador:t.getDataAtRow(e)[0],id_horario_turno:t.getDataAtRow(e)[3],fecha:t.getDataAtRow(e)[4],valor_nuevo:i,columna:d}),a+=1}})),a>0){let e=new FormData;e.append("cambios",JSON.stringify(n)),e.append("usuario",$("#session_usuario_id").val()),e.append("usuario_rol",$("#session_rol_id").val()),fetch(`${environment.apiSRD}/API/julia/asistencia/diaria/modificar-horario`,{method:"POST",body:e}).then((e=>e.json())).then((e=>{1==e.estado?e.data.cambios>0?i().then((()=>{msgSuccessMixin("Los cambios se han aplicado exitosamente","")})):i().then((()=>{msgWarningMixin("No se han realizado los cambios, verifique e intente de nuevo","")})):msgError(ErrorMensaje(e),(()=>{}),(()=>{}))}))}}})),document.querySelector("#boton-actualizar-horario").addEventListener("click",(function(e){e.preventDefault(),msgLoad("Procesando..."),i().then((()=>{msgSuccessMixin("Se han actualizado la tabla exitosamente","")}))})),document.querySelector("#boton-exportar-horario").addEventListener("click",(function(a){a.preventDefault(),msgLoad("Procesando...");var t=new FormData(e);t.append("usuario",$("#session_usuario_id").val()),t.append("usuario_rol",$("#session_rol_id").val()),t.append("periodo",$('[name="filtro-periodos"]').val()),t.append("colaborador",$('[name="filtro-colaborador"]').val()),t.append("ocupacion",$('[name="filtro-ocupacion"]').val()),t.append("desempenio",$('[name="filtro-desempenio"]').val()),t.append("areaperiodo",$('[name="filtro-areaperiodo"]').val()),t.append("estado",$('[name="filtro-estado"]').val()),fetch(`${environment.apiSRD}/API/julia/horario/listar`,{method:"POST",body:t}).then((e=>e.text())).then((e=>{console.log(e);const a=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=window.URL.createObjectURL(a),o=document.createElement("a");o.href=t,o.download="CE_Lista_horario.csv",document.body.appendChild(o),o.click(),o.remove()})).catch((e=>{msgError("Error al procesar los datos: "+e,(()=>{}),(()=>{}))})).finally((()=>{msgSuccessMixin("Se ha descargado el documento exitosamente","")}))}))},updateTableHeight:d}}();KTUtil.onDOMContentLoaded((function(){KTDiaria.init()})),window.addEventListener("resize",KTDiaria.updateTableHeight);