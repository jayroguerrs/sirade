"use strict";import{environment}from"../../../../../../../environment.js";var KTPeriodo=function(){var e,a,o,t;return{init:function(){o=document.getElementById("form_modal_agregar_periodos"),a=document.getElementById("kt_modal_agregar_periodos_submit"),document.getElementById("kt_modal_agregar_periodos_cancel"),(t=$("#tb_periodos").DataTable({autoWidth:!1,searchDelay:500,processing:!0,serverSide:!0,scrollX:!0,order:[[3,"desc"]],select:{style:"single",toggleable:!1},stateSave:!1,ajax:{type:"POST",url:`${environment.apiSRD}/API/periodos/lista-paginado`,data:function(e){var a=ObtenerDatos();e.idapp=a.idapp,e.periodo=a.periodo,e.fecha=a.fecha,e.estado=a.estado,e.usuario=$("#session_usuario_id").val(),e.usuario_rol=$("#session_rol_id").val()},beforeSend:function(){msgLoad("Procesando...")},complete:function(){msgAutoClose()},dataFilter:function(e){return 2==jQuery.parseJSON(e).estado&&location.reload(),e}},columns:[{data:null,name:"acciones"},{data:0,name:"NPERI_ID"},{data:1,name:"CPERI_DESCRIPCION"},{data:2,name:"DPERI_INICIO"},{data:3,name:"DPERI_FIN"},{data:4,name:"ESTADO"},{data:5,name:"FEC_MODIFICACION"},{data:6,name:"USR_MODIFICACION"}],columnDefs:[{targets:0,visible:!0,orderable:!1,className:"text-start",render:function(e,a,o){return`\n                            <button class="btn btn-sm btn-icon btn bg-light-primary btn-active-color-primary w-30px h-30px view-btn hover-scale" data-id="${o[0]}">\n                                <i class="ki-duotone ki-eye text-primary fs-2">\n                                    <span class="path1"></span>\n                                    <span class="path2"></span>\n                                    <span class="path3"></span>\n                                    <span class="path4"></span>\n                                    <span class="path5"></span>\n                                </i>\n                            </button>\n                            <button class="btn btn-sm btn-icon btn bg-light-warning btn-active-color-primary w-30px h-30px edit-btn hover-scale" data-id="${o[0]}">\n                                <i class="ki-duotone ki-notepad-edit text-warning fs-2">\n                                    <span class="path1"></span>\n                                    <span class="path2"></span>\n                                    <span class="path3"></span>\n                                    <span class="path4"></span>\n                                    <span class="path5"></span>\n                                </i>\n                            </button>\n                            <button class="btn btn-sm btn-icon btn bg-light-danger btn-active-color-primary w-30px h-30px delete-btn hover-scale" data-id="${o[0]}">\n                                <i class="ki-duotone ki-trash text-danger fs-2">\n                                    <span class="path1"></span>\n                                    <span class="path2"></span>\n                                    <span class="path3"></span>\n                                    <span class="path4"></span>\n                                    <span class="path5"></span>\n                                </i>\n                            </button>\n                        `}},{targets:1,visible:!1},{targets:5,visible:!0,render:function(e,a,o){return`\n                            <div class="badge badge-light-${"ACTIVO"==e?"success":"danger"} fw-bold">${e}</div>\n                        `}}]})).on("draw.dt",(function(){t.row(":eq(0)").select()})),t.$,t.on("draw",(function(){KTMenu.createInstances(),$(".view-btn").on("click",(function(){AbrirModalPeriodo($(this).data("id"),"ver")})),$(".edit-btn").on("click",(function(){AbrirModalPeriodo($(this).data("id"),"editar")})),$(".delete-btn").on("click",(function(){EliminarPeriodo($(this).data("id"))}))})),$("form#form_modal_agregar_periodos [name=fecha]").flatpickr({altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",mode:"range",locale:"es"}),$("form#form_modal_filtro_periodos [name=filtro-fecha]").flatpickr({altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",mode:"range",locale:"es"}),function(){const e=document.querySelector('[data-kt-periodos-table-filter="search"]');let a=e.value;e.addEventListener("change",(function(e){const o=e.target.value;o!==a&&(t.search(o).draw(),a=o)}))}(),e=FormValidation.formValidation(o,{fields:{periodo:{validators:{notEmpty:{message:"El periodo es requerido"}}},fecha:{validators:{notEmpty:{message:"La fecha es requerida"}}},estado:{validators:{integer:{message:"El estado debe ser un valor válido"}}}},plugins:{trigger:new FormValidation.plugins.Trigger,bootstrap:new FormValidation.plugins.Bootstrap5({rowSelector:".fv-row",eleInvalidClass:"",eleValidClass:""})}}),a.addEventListener("click",(r=>{r.preventDefault(),e&&e.validate().then((function(r){if("Valid"==r){msgLoad("Procesando..."),a.setAttribute("data-kt-indicator","on"),a.disabled=!0;var n=new FormData(o);n.append("idapp","ENF_002"),n.append("usuario",$("#session_usuario_id").val()),n.append("usuario_rol",$("#session_rol_id").val()),n.append("periodo",$('[name="periodo"]').val());var i="Agregar Periodo"==document.getElementById("titulo_modal").innerText?"agregar":"editar";msgConfirm("¿Está seguro que desea guardar los datos?",(()=>{fetch(`${environment.apiSRD}/API/periodos/${i}-periodo`,{method:"POST",body:n}).then((e=>e.json())).then((a=>{1==a.estado?($('[name="id"]').val(null).trigger("change"),$('[name="periodo"]').val(null).trigger("change"),$('[name="fecha"]').val(null).trigger("change"),document.querySelector('input[name="estado"][value="1"]').checked=!1,document.querySelector('input[name="estado"][value="0"]').checked=!1,e.resetForm(),$("#kt_modal_agregar_periodos").modal("hide"),t.order([5,"desc"]).page("first").draw(!1),new Promise((e=>{t.ajax.reload((()=>{e()}),!1)})).then((()=>{"agregar"==i?msgSuccess("Los cambios han sido guardados exitosamente"):msgSuccessMixin("Los cambios han sido guardados exitosamente","")}))):msgError(ErrorMensaje(a),(()=>{2==a.estado&&location.reload()}),(()=>{2==a.estado&&location.reload()}))})).catch((e=>{msgError("Error al procesar los datos: "+e)})).finally((()=>{a.setAttribute("data-kt-indicator","off"),a.disabled=!1}))}),(()=>{a.setAttribute("data-kt-indicator","off"),a.disabled=!1}))}}))})),document.querySelector('[name="agregar-boton"]').addEventListener("click",(function(){AbrirModalPeriodo(null,"agregar")})),document.querySelector("#boton-exportar-periodo").addEventListener("click",(function(e){e.preventDefault(),msgLoad("Procesando...");var a=new FormData(o);a.append("idapp","ENF_002"),a.append("usuario",$("#session_usuario_id").val()),a.append("usuario_rol",$("#session_rol_id").val()),a.append("periodo",$("[name='filtro-categoria']").val()),a.append("fecha",$("[name='filtro-fecha']").val()),a.append("estado",$("[name='filtro-estado']").val()),fetch(`${environment.apiSRD}/API/periodos/listar`,{method:"POST",body:a}).then((e=>{if(e.ok)return e.blob();throw new Error("Error al generar el CSV")})).then((e=>{const a=window.URL.createObjectURL(e),o=document.createElement("a");o.href=a,o.download="CE_Lista_Periodos.csv",document.body.appendChild(o),o.click(),o.remove()})).catch((e=>{msgError("Error al procesar los datos: "+e,(()=>{}),(()=>{}))})).finally((()=>{msgSuccessMixin("Se ha descargado el documento exitosamente","")}))})),document.querySelector("#kt_modal_filtro_periodos_submit").addEventListener("click",(function(e){e.preventDefault(),msgLoad("Procesando..."),$("#kt_modal_filtro_periodos").modal("hide"),new Promise((e=>{t.ajax.reload((function(){e()}))})).then((()=>{msgSuccessMixin("Los filtros se han aplicado exitosamente","")}))})),document.querySelector("#kt_modal_filtro_periodos_limpiar").addEventListener("click",(function(e){e.preventDefault(),document.getElementById("form_modal_filtro_periodos").reset(),$('[name="filtro-periodos"]').val(null).trigger("change"),$('[name="filtro-fecha"]').val(null).trigger("change"),$("form#form_modal_filtro_periodos [name=filtro-fecha]").flatpickr({altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",mode:"range",locale:"es"}).setDate([null,null]),document.querySelector('input[name="filtro-estado"][value="1"]').checked=!1,document.querySelector('input[name="filtro-estado"][value="0"]').checked=!1,new Promise((e=>{t.ajax.reload((function(){e()}))})).then((()=>{msgSuccessMixin("Los filtros se han limpiado exitosamente","")}))})),$("#kt_modal_agregar_periodos").on("hidden.bs.modal",(function(){$('[name="id"]').val(null).trigger("change"),$('[name="periodo"]').val(null).trigger("change"),$("form#form_modal_agregar_periodos [name=fecha]").flatpickr({altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",mode:"range",locale:"es"}).setDate([null,null]),document.querySelector('input[name="estado"][value="1"]').checked=!1,document.querySelector('input[name="estado"][value="0"]').checked=!1,e.resetForm()}))}}}();function AbrirModalPeriodo(e,a){if(msgLoad("Procesando..."),"editar"==a||"ver"==a){"ver"==a?($("#form_modal_agregar_periodos").find("input, select, textarea").prop("disabled",!0),$("#kt_modal_agregar_periodos_submit").hide()):($("#form_modal_agregar_periodos").find("input, select, textarea").prop("disabled",!1),$("#kt_modal_agregar_periodos_submit").show());var o=new FormData;o.append("idapp","ENF_002"),o.append("usuario",$("#session_usuario_id").val()),o.append("usuario_rol",$("#session_rol_id").val()),o.append("id",e),fetch(`${environment.apiSRD}/API/periodos/obtener-por-id`,{method:"POST",body:o}).then((e=>e.json())).then((e=>{if(1==e.estado){var a=e.data,o=$("form#form_modal_agregar_periodos [name=fecha]").flatpickr({altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",mode:"range",locale:"es"});$('[name="id"]').val(a.id).trigger("change"),$('[name="periodo"]').val(a.periodo).trigger("change"),o.setDate([a.fecha_inicio,a.fecha_fin]),document.querySelector(`input[name="estado"][value="${a.estado}"]`).checked=!0,msgAutoClose(),$("#kt_modal_agregar_periodos").modal("show")}else msgError(ErrorMensaje(e),(()=>{location.reload()}),(()=>{location.reload()}))})),document.getElementById("div-estado").style.display="block",document.getElementById("titulo_modal").innerText="Editar Periodo"}else document.getElementById("div-estado").style.display="none",document.getElementById("titulo_modal").innerText="Agregar Periodo",$("#form_modal_agregar_periodos").find("input, select, textarea").prop("disabled",!1),$("#kt_modal_agregar_compania_submit").show(),msgAutoClose(),$("#kt_modal_agregar_periodos").modal("show")}function EliminarPeriodo(e){var a=new FormData;a.append("idapp","ENF_002"),a.append("usuario",$("#session_usuario_id").val()),a.append("usuario_rol",$("#session_rol_id").val()),a.append("id",e),msgWarning("¿Está seguro que desea eliminar el periodo?","Si, Eliminar",(()=>{msgLoad("Procesando..."),fetch(`${environment.apiSRD}/API/periodos/eliminar-periodo`,{method:"POST",body:a}).then((e=>e.json())).then((e=>{if(1==e.estado){var a=$("#tb_periodos").DataTable();new Promise((e=>{a.ajax.reload((function(){e()}))})).then((()=>{msgSuccessMixin("El periodo ha sido eliminado exitosamente","")}))}else msgError(ErrorMensaje(e),(()=>{location.reload()}),(()=>{location.reload()}))}))}))}function ObtenerDatos(){var e,a=Boolean(document.querySelector('input[name="filtro-estado"][value="1"]').checked),o=Boolean(document.querySelector('input[name="filtro-estado"][value="0"]').checked);0==a&&0==o?e="":1==a&&0==o?e="1":0==a&&1==o&&(e="0");var t=new Array;return t.idapp="ENF_002",t.periodo=$("[name='filtro-periodo']").val(),t.fecha=$("[name='filtro-fecha']").val(),t.estado=e,t.usuario=$("#session_usuario_id").val(),t.usuario_rol=$("#session_rol_id").val(),t}KTUtil.onDOMContentLoaded((function(){KTPeriodo.init()})),window.AbrirModalPeriodo=AbrirModalPeriodo,window.EliminarPeriodo=EliminarPeriodo;