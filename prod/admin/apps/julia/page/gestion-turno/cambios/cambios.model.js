"use strict";import{environment}from"../../../../../../environment.js";var KTCambios=function(){var e,a,o,t,n,r;return{init:function(){o=document.getElementById("form_modal_agregar_cambio"),a=document.getElementById("kt_modal_agregar_cambio_submit"),document.getElementById("kt_modal_agregar_cambio_cancel"),(t=$("#tb_cambios").DataTable({autoWidth:!1,searchDelay:500,processing:!0,serverSide:!0,scrollX:!0,order:[[1,"asc"]],select:{style:"single",toggleable:!1},stateSave:!1,ajax:{type:"POST",url:`${environment.apiSRD}/API/julia/turnos/gestion/cambios/listar-paginado`,data:function(e){var a=ObtenerDatos();e.codigo=a.codigo,e.solicitante=a.solicitante,e.receptor=a.receptor,e.estado=a.estado,e.usuario=$("#session_usuario_id").val(),e.usuario_rol=$("#session_rol_id").val()},beforeSend:function(){msgLoad("Procesando...")},complete:function(){msgAutoClose()},dataFilter:function(e){return 2==jQuery.parseJSON(e).estado&&location.reload(),e}},columns:[{data:null,name:"acciones"},{data:0,name:"NCATU_ID"},{data:1,name:"CCATU_CODIGO"},{data:2,name:"SOLICITANTE"},{data:3,name:"DCATU_FECHA_SOLICITANTE"},{data:4,name:"CTURN_ID_SOLICITANTE"},{data:5,name:"RANGO_SOL"},{data:6,name:"RECEPTOR"},{data:7,name:"DCATU_FECHA_RECEPTOR"},{data:8,name:"CTURN_ID_RECEPTOR"},{data:9,name:"RANGO_REC"},{data:10,name:"ESTADO"},{data:11,name:"FEC_MODIFICACION"},{data:12,name:"USR_MODIFICACION"}],columnDefs:[{targets:0,visible:!0,orderable:!1,className:"text-start",render:function(e,a,o){return`\n                            <button class="btn btn-sm btn-icon btn bg-light-primary btn-active-color-primary w-30px h-30px view-btn hover-scale" data-id="${o[0]}">\n                                <i class="ki-duotone ki-eye text-primary fs-2">\n                                    <span class="path1"></span>\n                                    <span class="path2"></span>\n                                    <span class="path3"></span>\n                                    <span class="path4"></span>\n                                    <span class="path5"></span>\n                                </i>\n                            </button>\n                            <button class="btn btn-sm btn-icon btn bg-light-warning btn-active-color-primary w-30px h-30px edit-btn hover-scale" data-id="${o[0]}">\n                                <i class="ki-duotone ki-notepad-edit text-warning fs-2">\n                                    <span class="path1"></span>\n                                    <span class="path2"></span>\n                                    <span class="path3"></span>\n                                    <span class="path4"></span>\n                                    <span class="path5"></span>\n                                </i>\n                            </button>\n                            <button class="btn btn-sm btn-icon btn bg-light-danger btn-active-color-primary w-30px h-30px delete-btn hover-scale" data-id="${o[0]}">\n                                <i class="ki-duotone ki-trash text-danger fs-2">\n                                    <span class="path1"></span>\n                                    <span class="path2"></span>\n                                    <span class="path3"></span>\n                                    <span class="path4"></span>\n                                    <span class="path5"></span>\n                                </i>\n                            </button>\n                        `}},{targets:1,visible:!1},{targets:11,visible:!0,render:function(e,a,o){return`\n                            <div class="badge badge-light-${"ACTIVO"==e?"success":"danger"} fw-bold">${e}</div>\n                        `}}]})).on("draw.dt",(function(){t.row(":eq(0)").select()})),t.$,t.on("draw",(function(){KTMenu.createInstances(),$(".view-btn").on("click",(function(){AbrirModalcambio($(this).data("id"),"ver")})),$(".edit-btn").on("click",(function(){AbrirModalcambio($(this).data("id"),"editar")})),$(".delete-btn").on("click",(function(){Eliminarcambio($(this).data("id"))}))})),function(){$('[name="fechasol"]').flatpickr({altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",locale:"es"}),$('[name="fecharec"]').flatpickr({altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",locale:"es"});const e=e=>{if(!e.id)return e.text;var a=document.createElement("span"),o="";return o+='<div class="d-flex align-items-center">',o+='<div class="d-flex flex-column">',o+='<span class="fs-4 fw-bold lh-1">'+e.text+"</span>",o+='<span class="text-muted fs-6">'+e.element.getAttribute("data-subtitulo")+"</span>",o+="</div>",o+="</div>",a.innerHTML=o,$(a)};$('[name="turnosol"]').select2({placeholder:"Seleccione una opción",minimumResultsForSearch:1/0,templateSelection:e,templateResult:e}),$('[name="turnorec"]').select2({placeholder:"Seleccione una opción",minimumResultsForSearch:1/0,templateSelection:e,templateResult:e})}(),function(){const e=document.querySelector('[data-kt-cambio-table-filter="search"]');let a=e.value;e.addEventListener("change",(function(e){const o=e.target.value;o!==a&&(t.search(o).draw(),a=o)}))}(),e=FormValidation.formValidation(o,{fields:{solicitante:{validators:{notEmpty:{message:"El nombre del solicitante es requerido"}}},fechasol:{validators:{notEmpty:{message:"La fecha del solicitante es requerida"},date:{format:"YYYY-MM-DD",message:"La fecha del solicitante no es válida"}}},periodosol:{validators:{notEmpty:{message:"El periodo del solicitante es requerido"}}},turnosol:{validators:{notEmpty:{message:"El turno del solicitante es requerido"}}},receptor:{validators:{notEmpty:{message:"El nombre del receptor es requerido"}}},fecharec:{validators:{notEmpty:{message:"La fecha del receptor es requerida"},date:{format:"YYYY-MM-DD",message:"La fecha del receptor no es válida"}}},periodorec:{validators:{notEmpty:{message:"El periodo del receptor es requerido"}}},turnorec:{validators:{notEmpty:{message:"El turno del receptor es requerido"}}},estado:{validators:{notEmpty:{message:"El estado es requerido"}}}},plugins:{trigger:new FormValidation.plugins.Trigger,bootstrap:new FormValidation.plugins.Bootstrap5({rowSelector:".fv-row",eleInvalidClass:"",eleValidClass:""})}}),a.addEventListener("click",(n=>{n.preventDefault(),e&&e.validate().then((function(n){if("Valid"==n){msgLoad("Procesando..."),a.setAttribute("data-kt-indicator","on"),a.disabled=!0;var r=new FormData(o);r.append("usuario",$("#session_usuario_id").val()),r.append("usuario_rol",$("#session_rol_id").val());var i="Agregar cambio"==document.getElementById("titulo_modal").innerText?"agregar":"editar";r.append("modo",i),msgConfirm("¿Está seguro que desea guardar los datos?",(()=>{fetch(`${environment.apiSRD}/API/julia/turnos/gestion/cambios/editar-datos`,{method:"POST",body:r}).then((e=>e.json())).then((a=>{1==a.estado?($('[name="cambio"]').val(null).trigger("change"),$('[name="descripcion"]').val(null).trigger("change"),document.querySelector('input[name="estado"][value="1"]').checked=!1,document.querySelector('input[name="estado"][value="0"]').checked=!1,e.resetForm(),$("#kt_modal_agregar_cambio").modal("hide"),t.order([4,"desc"]),new Promise((e=>{t.ajax.reload((()=>{e()}),!1)})).then((()=>{"agregar"==i?msgSuccess("Los cambios han sido guardados exitosamente"):msgSuccessMixin("Los cambios han sido guardados exitosamente","")}))):msgError(ErrorMensaje(a),(()=>{2==a.estado&&location.reload()}),(()=>{2==a.estado&&location.reload()}))})).catch((e=>{msgError("Error al procesar los datos: "+e)})).finally((()=>{a.setAttribute("data-kt-indicator","off"),a.disabled=!1}))}),(()=>{a.setAttribute("data-kt-indicator","off"),a.disabled=!1}))}}))})),document.querySelector("#kt_modal_filtro_cambio_submit").addEventListener("click",(function(e){e.preventDefault(),msgLoad("Procesando..."),$("#kt_cambio_filtro_modal").modal("hide"),new Promise((e=>{t.ajax.reload((function(){e()}))})).then((()=>{msgSuccessMixin("Los filtros se han aplicado exitosamente","")}))})),document.querySelector("#kt_modal_filtro_cambio_limpiar").addEventListener("click",(function(e){e.preventDefault(),document.getElementById("form_modal_filtro_cambio").reset(),$('[name="filtro-cambio"]').val(null).trigger("change"),$('[name="filtro-descripcion"]').val(null).trigger("change"),document.querySelector('input[name="filtro-estado"][value="1"]').checked=!1,document.querySelector('input[name="filtro-estado"][value="0"]').checked=!1,new Promise((e=>{t.ajax.reload((function(){e()}))})).then((()=>{msgSuccessMixin("Los filtros se han limpiado exitosamente","")}))})),$("#kt_modal_agregar_cambio").on("hidden.bs.modal",(function(){o.reset(),$('[name="fechasol"]').val(null).trigger("change"),$('[name="fecharec"]').val(null).trigger("change"),$('[name="periodosol"]').val(null).trigger("change"),$('[name="periodorec"]').val(null).trigger("change"),$('[name="turnosol"]').val(null).trigger("change"),$('[name="turnorec"]').val(null).trigger("change"),document.querySelector('input[name="estado"][value="1"]').checked=!1,document.querySelector('input[name="estado"][value="0"]').checked=!1,e.resetForm()})),document.querySelector('[name="agregar-boton"]').addEventListener("click",(function(){AbrirModalcambio(null,"agregar")})),document.querySelector("#boton-exportar-cambio").addEventListener("click",(function(e){e.preventDefault(),msgLoad("Procesando...");var a=new FormData(o);a.append("codigo",$('[name="filtro-codigo"]').val()),a.append("solicitante",$('[name="filtro-solicitante"]').val()),a.append("receptor",$('[name="filtro-receptor"]').val()),a.append("usuario",$("#session_usuario_id").val()),a.append("usuario_rol",$("#session_rol_id").val()),fetch(`${environment.apiSRD}/API/julia/turnos/gestion/cambios/listar`,{method:"POST",body:a}).then((e=>{if(e.ok)return e.blob();throw new Error("Error al generar el CSV")})).then((e=>{const a=window.URL.createObjectURL(e),o=document.createElement("a");o.href=a,o.download="CE_Lista_Cambios_Turnos.csv",document.body.appendChild(o),o.click(),o.remove()})).catch((e=>{msgError("Error al procesar los datos: "+e,(()=>{}),(()=>{}))})).finally((()=>{msgSuccessMixin("Se ha descargado el documento exitosamente","")}))})),document.querySelector("#btn_solicitante").addEventListener("click",(function(){msgLoad("Procesando...");var e=new FormData;e.append("colaborador",$('[name="solicitante"]').val()),e.append("fecha",$('[name="fechasol"]').val()),e.append("periodo",$('[name="periodosol"]').val()),e.append("usuario",$("#session_usuario_id").val()),e.append("usuario_rol",$("#session_rol_id").val()),fetch(`${environment.apiSRD}/API/julia/turnos/gestion/cambios/buscar-por-fecha`,{method:"POST",body:e}).then((e=>e.json())).then((e=>{if(1==e.estado){for(var a=e.data,o="",t=0;t<a.length;t++)o+=`<option value="${a[t].Id}" data-subtitulo="${a[t].HoraEntrada} - ${a[t].HoraSalida}">${a[t].Id}</option>`;$('[name="turnosol"]').html(o).trigger("change"),msgSuccess("Se encontraron turnos para el solicitante")}else 0==e.estado?(msgErrorNormal("No se encontraron turnos para el solicitante"),$('[name="turnosol"]').empty().trigger("change")):msgError(ErrorMensaje(e),(()=>{2==e.estado&&location.reload()}),(()=>{2==e.estado&&location.reload()}))}))})),document.querySelector("#btn_receptor").addEventListener("click",(function(){msgLoad("Procesando...");var e=new FormData;e.append("colaborador",$('[name="receptor"]').val()),e.append("fecha",$('[name="fecharec"]').val()),e.append("periodo",$('[name="periodorec"]').val()),e.append("usuario",$("#session_usuario_id").val()),e.append("usuario_rol",$("#session_rol_id").val()),fetch(`${environment.apiSRD}/API/julia/turnos/gestion/cambios/buscar-por-fecha`,{method:"POST",body:e}).then((e=>e.json())).then((e=>{if(1==e.estado){for(var a=e.data,o="",t=0;t<a.length;t++)o+=`<option value="${a[t].Id}" data-subtitulo="${a[t].HoraEntrada} - ${a[t].HoraSalida}">${a[t].Id}</option>`;$('[name="turnorec"]').html(o).trigger("change"),msgSuccess("Se encontraron turnos para el receptor")}else 0==e.estado?(msgErrorNormal("No se encontraron turnos para el receptor"),$('[name="turnorec"]').empty().trigger("change")):msgError(ErrorMensaje(e),(()=>{2==e.estado&&location.reload()}),(()=>{2==e.estado&&location.reload()}))}))})),document.querySelector('[name="solicitante"]').addEventListener("click",(function(e){e.preventDefault(),$("#kt_buscar_usuario").modal("show"),n=$("#tb_usuario").DataTable({destroy:!0,autoWidth:!1,searchDelay:500,serverSide:!0,scrollX:!1,select:!0,order:[[1,"asc"]],stateSave:!1,ajax:{type:"POST",url:`${environment.apiSRD}/API/julia/usuarios/listar-paginado`,data:function(e){e.usuario=$("#session_usuario_id").val(),e.usuario_rol=$("#session_rol_id").val()},beforeSend:function(){msgLoad("Procesando...")},complete:function(){msgAutoClose()},dataFilter:function(e){return 2==jQuery.parseJSON(e).estado&&location.reload(),e}},columns:[{data:0,name:"NUSUA_ID"},{data:1,name:"CUSUA_NOMBRES"}],columnDefs:[{targets:0,visible:!1},{targets:1,visible:!0},{targets:2,visible:!0,data:null,orderable:!1,className:"text-end",render:function(e,a,o){return'\n                            <button class="btn btn-light btn-active-light-primary btn-sm selection-btn2 hover-scale">\n                                <span class="me-2 ">Seleccionar</span>\n                                <i class="ki-duotone ki-double-right fs-2">\n                                    <span class="path1"></span>\n                                    <span class="path2"></span>\n                                </i>\n                            </button>\n                        '}}]}),n.$,n.on("draw",(function(){KTMenu.createInstances(),$(".selection-btn2").on("click",(function(){msgLoad("Procesando...");var e=n.row($(this).parents("tr")).data(),a=new FormData;a.append("usuario",$("#session_usuario_id").val()),a.append("usuario_rol",$("#session_rol_id").val()),a.append("id",e[0]),fetch(`${environment.apiSRD}/API/julia/usuarios/obtener-por-id`,{method:"POST",body:a}).then((e=>e.json())).then((e=>{if(1==e.estado){var a=e.data;$('[name="solicitante"]').val(a.nombres).trigger("change"),$('[name="turnosol"]').empty().trigger("change"),msgAutoClose(),$("#kt_buscar_usuario").modal("hide"),document.querySelector('[data-kt-usuario-table-filter="Buscar"]').value=""}else msgError(ErrorMensaje(e),(()=>{2==e.estado&&location.reload()}),(()=>{2==e.estado&&location.reload()}))}))}))}))})),document.querySelector('[name="receptor"]').addEventListener("click",(function(e){e.preventDefault(),$("#kt_buscar_usuario").modal("show"),r=$("#tb_usuario").DataTable({destroy:!0,autoWidth:!1,searchDelay:500,serverSide:!0,scrollX:!1,select:!0,order:[[1,"asc"]],stateSave:!1,ajax:{type:"POST",url:`${environment.apiSRD}/API/julia/usuarios/listar-paginado`,data:function(e){e.usuario=$("#session_usuario_id").val(),e.usuario_rol=$("#session_rol_id").val()},beforeSend:function(){msgLoad("Procesando...")},complete:function(){msgAutoClose()},dataFilter:function(e){return 2==jQuery.parseJSON(e).estado&&location.reload(),e}},columns:[{data:0,name:"NUSUA_ID"},{data:1,name:"CUSUA_NOMBRES"}],columnDefs:[{targets:0,visible:!1},{targets:1,visible:!0},{targets:2,visible:!0,data:null,orderable:!1,className:"text-end",render:function(e,a,o){return'\n                            <button class="btn btn-light btn-active-light-primary btn-sm selection-btn hover-scale">\n                                <span class="me-2 ">Seleccionar</span>\n                                <i class="ki-duotone ki-double-right fs-2">\n                                    <span class="path1"></span>\n                                    <span class="path2"></span>\n                                </i>\n                            </button>\n                        '}}]}),r.$,r.on("draw",(function(){KTMenu.createInstances(),$(".selection-btn").on("click",(function(){msgLoad("Procesando...");var e=r.row($(this).parents("tr")).data(),a=new FormData;a.append("usuario",$("#session_usuario_id").val()),a.append("usuario_rol",$("#session_rol_id").val()),a.append("id",e[0]),fetch(`${environment.apiSRD}/API/julia/usuarios/obtener-por-id`,{method:"POST",body:a}).then((e=>e.json())).then((e=>{if(1==e.estado){var a=e.data;$('[name="receptor"]').val(a.nombres).trigger("change"),$('[name="turnorec"]').empty().trigger("change"),msgAutoClose(),$("#kt_buscar_usuario").modal("hide"),document.querySelector('[data-kt-usuario-table-filter="Buscar"]').value=""}else msgError(ErrorMensaje(e),(()=>{2==e.estado&&location.reload()}),(()=>{2==e.estado&&location.reload()}))}))}))}))})),document.querySelector("#btn-actualizar-usuario").addEventListener("click",(function(e){e.preventDefault(),n.ajax.reload()}))}}}();function ObtenerDatos(){var e,a=Boolean(document.querySelector('input[name="filtro-estado"][value="1"]').checked),o=Boolean(document.querySelector('input[name="filtro-estado"][value="0"]').checked);0==a&&0==o?e="":1==a&&0==o?e="1":0==a&&1==o&&(e="0");var t=new Array;return t.solicitante=$("[name='filtro-solicitante']").val(),t.receptor=$("[name='filtro-receptor']").val(),t.fechasol=$("[name='filtro-descripcion']").val(),t.estado=e,t.usuario=$("#session_usuario_id").val(),t.usuario_rol=$("#session_rol_id").val(),t}function AbrirModalcambio(e,a){if(msgLoad("Procesando..."),"editar"==a||"ver"==a){"ver"==a?($("#form_modal_agregar_cambio").find("input, select, textarea").prop("disabled",!0),$("#btn_solicitante").prop("disabled",!0),$("#btn_receptor").prop("disabled",!0),$("#kt_modal_agregar_cambio_submit").hide()):($("#form_modal_agregar_cambio").find("input, select, textarea").prop("disabled",!1),$("#btn_solicitante").prop("disabled",!1),$("#btn_receptor").prop("disabled",!1),$("#kt_modal_agregar_cambio_submit").show());var o=new FormData;o.append("usuario",$("#session_usuario_id").val()),o.append("usuario_rol",$("#session_rol_id").val()),o.append("id",e),fetch(`${environment.apiSRD}/API/julia/turnos/gestion/cambios/obtener-por-id`,{method:"POST",body:o}).then((e=>e.json())).then((e=>{if(1==e.estado){var a=e.data;$('[name="id"]').val(a.Id).trigger("change"),$('[name="codigo"]').val(a.Codigo).trigger("change"),$('[name="solicitante"]').val(a.Solicitante).trigger("change"),$('[name="periodosol"]').val(a.PeriodoSolicitante).trigger("change"),$('[name="periodorec"]').val(a.PeriodoReceptor).trigger("change"),$('[name="turnosol"]').val(a.TurnoSolicitante).trigger("change"),$('[name="rangosolini"]').val(a.RangoIniSol).trigger("change"),$('[name="rangosolfin"]').val(a.RangoFinSol).trigger("change"),$('[name="receptor"]').val(a.Receptor).trigger("change"),$('[name="turnorec"]').val(a.TurnoReceptor).trigger("change"),$('[name="rangorecini"]').val(a.RangoIniRec).trigger("change"),$('[name="rangorecfin"]').val(a.RangoFinRec).trigger("change"),$('[name="fechasol"]').flatpickr({altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",locale:"es"}).setDate([a.FechaSolicitante]),$('[name="fecharec"]').flatpickr({altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",locale:"es"}).setDate([a.FechaReceptor]),(e=new FormData).append("colaborador",a.Solicitante),e.append("fecha",a.FechaSolicitante),e.append("periodo",a.PeriodoSolicitante),e.append("usuario",$("#session_usuario_id").val()),e.append("usuario_rol",$("#session_rol_id").val()),fetch(`${environment.apiSRD}/API/julia/turnos/gestion/cambios/buscar-por-fecha`,{method:"POST",body:e}).then((e=>e.json())).then((e=>{if(1==e.estado){for(var o=e.data,t="",n=0;n<o.length;n++)t+=`<option value="${o[n].Id}" data-subtitulo="${o[n].HoraEntrada} - ${o[n].HoraSalida}">${o[n].Id}</option>`;$('[name="turnosol"]').html(t).trigger("change"),$('[name="turnosol"]').val(a.TurnoSolicitante).trigger("change")}})),(e=new FormData).append("colaborador",a.Receptor),e.append("fecha",a.FechaReceptor),e.append("periodo",a.PeriodoReceptor),e.append("usuario",$("#session_usuario_id").val()),e.append("usuario_rol",$("#session_rol_id").val()),fetch(`${environment.apiSRD}/API/julia/turnos/gestion/cambios/buscar-por-fecha`,{method:"POST",body:e}).then((e=>e.json())).then((e=>{if(1==e.estado){for(var o=e.data,t="",n=0;n<o.length;n++)t+=`<option value="${o[n].Id}" data-subtitulo="${o[n].HoraEntrada} - ${o[n].HoraSalida}">${o[n].Id}</option>`;$('[name="turnorec"]').html(t).trigger("change"),$('[name="turnorec"]').val(a.TurnoReceptor).trigger("change")}})),document.querySelector(`input[name="estado"][value="${a.Estado}"]`).checked=!0,msgAutoClose(),$("#kt_modal_agregar_cambio").modal("show")}else msgError(ErrorMensaje(e),(()=>{2==e.estado&&location.reload()}),(()=>{2==e.estado&&location.reload()}))})),document.getElementById("div-estado").style.display="block",document.getElementById("titulo_modal").innerText="Editar cambio"}else document.getElementById("div-estado").style.display="none",document.getElementById("titulo_modal").innerText="Agregar cambio",$("#form_modal_agregar_cambio").find("input, select, textarea").prop("disabled",!1),$("#kt_modal_agregar_cambio_submit").show(),$("#btn_solicitante").prop("disabled",!1),$("#btn_receptor").prop("disabled",!1),$('[name="codigo"]').hide(),msgAutoClose(),$("#kt_modal_agregar_cambio").modal("show")}function Eliminarcambio(e){var a=new FormData;a.append("usuario",$("#session_usuario_id").val()),a.append("usuario_rol",$("#session_rol_id").val()),a.append("id",e),msgWarning("¿Está seguro que desea eliminar el periodo?","Si, Eliminar",(()=>{msgLoad("Procesando..."),fetch(`${environment.apiSRD}/API/julia/cambios/eliminar`,{method:"POST",body:a}).then((e=>e.json())).then((e=>{if(1==e.estado){var a=$("#tb_periodos").DataTable();new Promise((e=>{a.ajax.reload((function(){e()}))})).then((()=>{msgSuccessMixin("El periodo ha sido eliminado exitosamente","")}))}else msgError(ErrorMensaje(e),(()=>{2==e.estado&&location.reload()}),(()=>{2==e.estado&&location.reload()}))}))}))}KTUtil.onDOMContentLoaded((function(){KTCambios.init()})),window.AbrirModalcambio=AbrirModalcambio,window.Eliminarcambio=Eliminarcambio;